## openai API计费信息总结（20230324）

[点击这里进行动态计费>>](http://192.168.5.116:7861)

目前gpt4模型暂且只向plus会员/通过了白名单申请的账号使用，
plus会员信息：
- 价格：20美元/月 = 140元/月 = 1680元/年/账号；
- plus会员网页端访问gpt4模型免费，目前gpt4模型限额 `25条提问/3小时`；
- plus会员限额走势：`100条/4小时 =》50条/3小时 =》 25条/3小时`

### 名词说明：
- **令牌**  ：openai api的tokens，参与计费的单位为 1K tokens，不足则向上取整；
- **1K**	  ：1024（暂未找到文档对这值的具体描述，程序界默认1k=1024，暂且按1024计算而不是1000）;
- **上下文**：为了让chatgpt保持会话语境一致而需要携带的数据，可以理解为每次会话都将历史聊天记录传给chatgpt（通过messages列表携带历史会话数据）

### 当前汇率：
- 1美元=6.8，存在浮动，这里按7元计算;

#### gpt4的计费：
- 1中文 ~= 1.3令牌
- 50w中文 = 65w令牌
- 参与计费的数值（向上取整）：65 * 10000 / 1024 = 635
- 按均值0.06计算：`635 * 0.06 * 7 = 266.7元（50万字）`
- 按高值0.12计算：`635 * 0.12 * 7 = 533.4元（50万字）`

|  类型 | 提示（提问内容）  |完成(返回结果)
| :------------ | :------------ |
|  8K 上下文 |   $0.03 / 1K 代币 | $0.06 / 1K 代币
|  32K 上下文 | $0.06 / 1K 代币  | $0.12 / 1K 代币

#### gpt3.5的计费：
- 1中文 ~= 1.3令牌
- 50w中文 = 65w令牌
- 参与计费的数值（向上取整）：65 * 10000 / 1024 = 635
- 按均值0.002计算：`635 * 0.002 * 7 = 8.89元（50万字）`

|  类型 | 提示（提问内容）  |完成(返回结果)
| :------------ | :------------ |
|  GPT-3.5|   $0.002 / 1K 代币 | $0.002 / 1K 代币


#### gpt2的计费：
- gpt2模型已久远，没找到具体的单价，这里暂且按gpt3的价格0.002价格计算
- 1中文 ~= 2令牌
- 50w中文 = 100w令牌
- 参与计费的数值（向上取整）：100 * 10000 / 1024 = 977
- 按均值0.002计算：`977 * 0.002 * 7 = 13.678元（50万字）`

|  类型 | 提示（提问内容）  |完成(返回结果)
| :------------ | :------------ |
|  GPT-2|   $0.002 / 1K 代币 | $0.002 / 1K 代币


### API计费文档：
官方令牌计算模拟（这里的的计算默认用的GPT-2，中文消耗的toekns更多）：https://platform.openai.com/tokenizer
官方令牌说明：https://help.openai.com/en/articles/4936856-what-are-tokens-and-how-to-count-them
官方计费介绍：https://openai.com/pricing


### 拓展信息：
经过验证，中文/中文字符根据结构不一样，分别可能会被openai标记为三种规格：
- 1个令牌（例如：的、【、】、。）；
- 2个令牌（例如：你、好、《、》）；
- 3个令牌（例如：：，；：）；
通过几批数据计算，平均值约 `1中文=2.3令牌`，这里统一按： `1中文=2令牌` 计算;

#### 关于openai的令牌（tokens）计算规则说明：
openai语言模型以"称为标记的块"的形式读取文本。在英语中，标记可以短至一个字符或长至一个单词，在某些语言中，标记甚至可以短于一个字符，甚至长于一个单词。

以下标记的令牌数计算基于[官方令牌计算模拟](https://platform.openai.com/tokenizer)，官网上的计算方式是基于gpt2模型的，中文会被标记未更多的令牌。而后续的gpt3、gpt4模型，计算中文令牌数会更少，相对而言更优惠。

目前基本都是用gpt3、gpt4模型，这里只是对令牌标记规则做简易说明。

例如：
##### 英文标记：
- "a apple"：
 - 被标记为：["a", "apple"]，
 - 实际标记块为：[64, 17180]，
 - 记为 2令牌；
- "ChatGPT is great!"：
 - 被标记为：["Chat", "G", "PT", " is", " great", "!"]
 - 实际标记块为：[30820, 38, 11571, 318, 1049, 0]
 - 记为 6令牌

##### 中文标记：
- "的"：
 - 实际标记块为：[21410]，
 - 记为 1令牌；
- "你"：
 - 实际标记块为：[19526, 254]，
 - 记为 2令牌；
- "；"：
 - 实际标记块为：[171, 120, 249]，
 - 记为 3令牌；


#### 使用代码计算令牌（tokens）数：

##### 离线模式：
 - 可使用`tiktoken`进行计算；
- github地址：https://github.com/openai/tiktoken/blob/main/README.md
- [点击这里进行动态计费>>](http://192.168.5.116:7861)

##### 从API的返回结果中查看：
要查看 API 调用使用了多少令牌，请检查 API 响应中的字段，例如：
	- response['usage']['total_tokens']

##### API调用价格所受的影响因素：
- API所使用的模型类型；
 - Tokenization算法：
   - GPT-3、GPT-4使用的是一种名为Byte Pair Encoding (BPE)的算法，`1中文 ~= 1.3令牌`；
   - 而GPT-2则使用的是一种基于WordPiece的算法。BPE算法可以更好地处理不常见的单词和短语，而WordPiece算法则更适合处理英语等常见语言；`1中文 ~= 2令牌`；
   - 中文环境，使用`GPT-3、GPT-4`模型，消耗的`令牌（tokens）`更少；
- API所发送与返回结果的总令牌数；